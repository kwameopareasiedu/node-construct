/* node-construct@v1.0.1 */
"use strict";var __awaiter=this&&this.__awaiter||function(e,o,l,u){return new(l=l||Promise)(function(n,r){function t(e){try{a(u.next(e))}catch(e){r(e)}}function i(e){try{a(u.throw(e))}catch(e){r(e)}}function a(e){var r;e.done?n(e.value):((r=e.value)instanceof l?r:new l(function(e){e(r)})).then(t,i)}a((u=u.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,t){var i,a,o,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:r(0),throw:r(1),return:r(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function r(r){return function(e){return function(r){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,a&&(o=2&r[0]?a.return:r[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,r[1])).done)return o;switch(a=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return l.label++,{value:r[1],done:!1};case 5:l.label++,a=r[1],r=[0];continue;case 7:r=l.ops.pop(),l.trys.pop();continue;default:if(!(o=0<(o=l.trys).length&&o[o.length-1])&&(6===r[0]||2===r[0])){l=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){l.label=r[1];break}if(6===r[0]&&l.label<o[1]){l.label=o[1],o=r;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(r);break}o[2]&&l.ops.pop(),l.trys.pop();continue}r=t.call(n,l)}catch(e){r=[6,e],a=0}finally{i=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,e])}}},__spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,r=0,n=arguments.length;r<n;r++)e+=arguments[r].length;for(var t=Array(e),i=0,r=0;r<n;r++)for(var a=arguments[r],o=0,l=a.length;o<l;o++,i++)t[i]=a[o];return t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.setup=void 0;var generate_1=require("./generate"),link_1=require("./link"),validRelations=["HAS_ONE","HAS_MANY","BELONGS_TO_ONE"];exports.setup=function(_,p,v,w,y){return void 0===y&&(y=!1),__awaiter(void 0,void 0,void 0,function(){var s,c,r,n,t,i,a,o,l,u,f,h,d;return __generator(this,function(e){switch(e.label){case 0:s=[],c=function(t,i){return 0<s.filter(function(e){var r=e[0],n=e[1];return r===i&&n===t}).length},r=w.reduce(function(e,r){var n=r.split(/[ |[|\]|,]/g),t=(n[0]||"").trim();if(!t)throw new Error('No source model found in "'+r+'" relation');var i=(n[1]||"").trim();if(!i)throw new Error('No relation type found in "'+r+'" relation');if(!validRelations.includes(i))throw new Error("Invalid relation type. Valid values are: "+validRelations.join(", "));var a=n.slice(2).map(function(e){return e.trim()}).filter(function(e){return!!e});if(!a||0==a.length)throw new Error('No target model(s) found in "'+r+'" relation');e.includes(t)||e.push(t);for(var o=0,l=a;o<l.length;o++){var u=l[o];if(y)s.push([t,u,i]);else{if(c(t,u)){throw new Error('Circular dependency detected between "'+t+'" and "'+u+'". (I.e. "'+t+'" depends on "'+u+'" and vice-versa). '+"If this is desired, run this command with --no-checks or -n")}s.push([t,u,i])}e.includes(u)||e.push(u)}return __spreadArrays(e)},[]),n=0,t=r,e.label=1;case 1:return n<t.length?(i=t[n],[4,generate_1.generate(_,p,v,i)]):[3,4];case 2:e.sent(),e.label=3;case 3:return n++,[3,1];case 4:a=function(r,n,t){var i;return __generator(this,function(e){switch(e.label){case 0:return i="HAS_ONE"===t?link_1.RelationType.HAS_ONE:"HAS_MANY"===t?link_1.RelationType.HAS_MANY:"BELONGS_TO_ONE"===t?link_1.RelationType.BELONGS_TO_ONE:void 0,[4,link_1.link(_,p,v,r,n,i)];case 1:return e.sent(),[2]}})},o=0,l=s,e.label=5;case 5:return o<l.length?(u=l[o],f=u[0],h=u[1],d=u[2],[5,a(f,h,d)]):[3,8];case 6:e.sent(),e.label=7;case 7:return o++,[3,5];case 8:return[2]}})})};