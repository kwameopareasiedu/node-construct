/* node-construct@v0.4.0 */
"use strict";var __awaiter=this&&this.__awaiter||function(e,i,l,p){return new(l=l||Promise)(function(r,t){function a(e){try{o(p.next(e))}catch(e){t(e)}}function n(e){try{o(p.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?r(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(a,n)}o((p=p.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(r,a){var n,o,i,l={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,o&&(i=2&t[0]?o.return:t[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,t[1])).done)return i;switch(o=0,i&&(t=[2&t[0],i.value]),t[0]){case 0:case 1:i=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,o=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(i=0<(i=l.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){l.label=t[1];break}if(6===t[0]&&l.label<i[1]){l.label=i[1],i=t;break}if(i&&l.label<i[2]){l.label=i[2],l.ops.push(t);break}i[2]&&l.ops.pop(),l.trys.pop();continue}t=a.call(r,l)}catch(e){t=[6,e],o=0}finally{n=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.link=exports.RelationType=void 0;var RelationType,path=require("path"),moment=require("moment"),prettier_1=require("prettier"),pluralize_1=require("pluralize"),recast_1=require("recast"),log_1=require("../core/log"),path_1=require("../core/path"),misc_1=require("../core/misc"),file_1=require("../core/file"),name_1=require("../core/name");!function(e){e[e.HAS_ONE=0]="HAS_ONE",e[e.HAS_MANY=1]="HAS_MANY",e[e.BELONGS_TO_ONE=2]="BELONGS_TO_ONE"}(RelationType=exports.RelationType||(exports.RelationType={})),exports.link=function(k,S,w,R,O,M){return __awaiter(void 0,void 0,void 0,function(){var n,o,i,l,p,m,s,u,d,y,c,_,f,h,b,g,T,v,N,F;return __generator(this,function(e){if(n=name_1.generateModelFolderNameFrom(R),o=name_1.generateModelFolderNameFrom(O),!path_1.pathExists(path.resolve(k,S,n)))throw new Error(R+" is not a valid model in the project");if(!path_1.pathExists(path.resolve(k,S,o)))throw new Error(O+" is not a valid model in the project");var t,r,a;return i=function(){if(M===RelationType.HAS_ONE)return generateASTForHasOneRelation(R,O);if(M===RelationType.HAS_MANY)return generateASTForHasManyRelation(R,O);if(M===RelationType.BELONGS_TO_ONE)return generateASTForBelongsToOneRelation(R,O);throw new Error("Invalid relation type")}(),l=name_1.generateModelNameFrom(R),p=path.resolve(k,S,n,"index.js"),m=recast_1.parse(file_1.readFile(p)),s=m.program.body.filter(function(e){return"ClassDeclaration"===e.type&&e.id.name===l})[0],u=s.body.body.filter(function(e){return"MethodDefinition"===e.type&&"relationMappings"===e.key.name})[0],u.value.body.body.filter(function(e){return"ReturnStatement"===e.type})[0].argument.properties.push(i),file_1.writeFile(p,prettier_1.format(recast_1.print(m).code,misc_1.prettierConfig)),d=function(){if(M===RelationType.HAS_ONE)return generateASTForBelongsToOneRelation(O,R);if(M===RelationType.HAS_MANY)return generateASTForBelongsToOneRelation(O,R);if(M===RelationType.BELONGS_TO_ONE)return generateASTForHasManyRelation(O,R);throw new Error("Invalid relation type")}(),y=name_1.generateModelNameFrom(O),c=path.resolve(k,S,o,"index.js"),_=recast_1.parse(file_1.readFile(c)),f=_.program.body.filter(function(e){return"ClassDeclaration"===e.type&&e.id.name===y})[0],h=f.body.body.filter(function(e){return"MethodDefinition"===e.type&&"relationMappings"===e.key.name})[0],h.value.body.body.filter(function(e){return"ReturnStatement"===e.type})[0].argument.properties.push(d),file_1.writeFile(c,prettier_1.format(recast_1.print(_).code,misc_1.prettierConfig)),b=name_1.generateDatabaseTableNameFrom(R),g=name_1.generateDatabaseTableNameFrom(O),T=[RelationType.HAS_ONE,RelationType.HAS_MANY].includes(M),v=path.resolve(__dirname,"../../templates/relation-migration.js.ejs"),N=file_1.renderTemplate(v,{sourceModelName:T?l:y,targetModelName:T?y:l,sourceDatabaseTableName:T?b:g,targetDatabaseTableName:T?g:b,targetDatabaseTableColumn:pluralize_1.singular(name_1.generateDatabaseTableNameFrom(T?R:O))+"_id"}),t=moment().format("YYYYMMDDHHmmssSSS"),r=T?g:b,a=pluralize_1.singular(name_1.generateDatabaseTableNameFrom(T?R:O))+"_id",F=path.resolve(k,w,t+"_add_"+a+"_to_"+r+"_table.js"),file_1.writeFile(F,prettier_1.format(N,misc_1.prettierConfig)),log_1.logSuccess("Successfully linked "+l+" model to "+y+" model!\n"),[2]})})};var generateASTForHasOneRelation=function(e,t){var r=name_1.generateDatabaseTableNameFrom(e)+".id",a=name_1.generateDatabaseTableNameFrom(t)+"."+pluralize_1.singular(name_1.generateDatabaseTableNameFrom(e))+"_id";return{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:pluralize_1.singular(name_1.generateDatabaseTableNameFrom(t))},value:{type:"ObjectExpression",properties:[{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:"relation"},value:{type:"MemberExpression",object:{type:"Identifier",name:"RootModel"},property:{type:"Identifier",name:"HasOneRelation"},computed:!1},kind:"init"},{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:"from"},value:{type:"Literal",value:r,raw:'"'+r+'"'},kind:"init"},{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:"to"},value:{type:"Literal",value:a,raw:'"'+a+'"'},kind:"init"}]},kind:"init"}},generateASTForHasManyRelation=function(e,t){var r=name_1.generateDatabaseTableNameFrom(e)+".id",a=name_1.generateDatabaseTableNameFrom(t)+"."+pluralize_1.singular(name_1.generateDatabaseTableNameFrom(e))+"_id";return{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:name_1.generateDatabaseTableNameFrom(t)},value:{type:"ObjectExpression",properties:[{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:"relation"},value:{type:"MemberExpression",object:{type:"Identifier",name:"RootModel"},property:{type:"Identifier",name:"HasManyRelation"},computed:!1},kind:"init"},{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:"from"},value:{type:"Literal",value:r,raw:'"'+r+'"'},kind:"init"},{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:"to"},value:{type:"Literal",value:a,raw:'"'+a+'"'},kind:"init"}]},kind:"init"}},generateASTForBelongsToOneRelation=function(e,t){var r=name_1.generateDatabaseTableNameFrom(e)+"."+pluralize_1.singular(name_1.generateDatabaseTableNameFrom(t))+"_id",a=name_1.generateDatabaseTableNameFrom(t)+".id";return{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:pluralize_1.singular(name_1.generateDatabaseTableNameFrom(t))},value:{type:"ObjectExpression",properties:[{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:"relation"},value:{type:"MemberExpression",object:{type:"Identifier",name:"RootModel"},property:{type:"Identifier",name:"BelongsToOneRelation"},computed:!1},kind:"init"},{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:"from"},value:{type:"Literal",value:r,raw:'"'+r+'"'},kind:"init"},{type:"Property",method:!1,shorthand:!1,computed:!1,key:{type:"Identifier",name:"to"},value:{type:"Literal",value:a,raw:'"'+a+'"'},kind:"init"}]},kind:"init"}};